<div class="mb-4 {{ css_class }}" x-data="nitroSelect({
    value: '{{ current_value|escapejs }}',
    label: '{{ current_label|escapejs }}',
    options: {{ options_json }},
    searchUrl: '{{ search_url|escapejs }}',
    parentInput: '{{ parent_input|escapejs }}',
    cascadeParam: '{{ cascade_param|escapejs }}'
})">
    <label for="{{ field_id }}" class="block text-sm font-medium text-gray-700 mb-1">
        {{ label }}{% if is_required %} <span class="text-red-500">*</span>{% endif %}
    </label>

    <div class="relative">
        {# Hidden input that holds the actual value for form submission #}
        {# Note: We set both value= (static fallback) and x-bind:value (Alpine reactive) #}
        <input type="hidden" name="{{ field_name }}" x-ref="hiddenInput" value="{{ current_value }}" x-bind:value="selectedValue">

        {# Display input - shows selected label or search text #}
        <div class="relative">
            <input
                type="text"
                x-show="!selectedValue || open"
                x-model="search"
                @input.debounce.200ms="filter()"
                @focus="open = true"
                @keydown="onKeydown($event)"
                @click.away="open = false"
                placeholder="{{ placeholder }}"
                autocomplete="off"
                class="w-full px-3 py-2 pr-8 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            >
            {# Selected value display #}
            <button
                type="button"
                x-show="selectedValue && !open"
                @click="open = true; $nextTick(() => $el.previousElementSibling.focus())"
                class="w-full px-3 py-2 pr-8 border border-gray-300 rounded-lg text-sm text-left bg-white hover:bg-gray-50 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            >
                <span x-text="selectedLabel" class="text-gray-900"></span>
            </button>

            {# Clear button #}
            <button
                type="button"
                x-show="selectedValue"
                @click.stop="clear()"
                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
            >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>

            {# Chevron icon when nothing selected #}
            <div x-show="!selectedValue" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>

        {# Dropdown #}
        <div
            x-show="open"
            x-cloak
            x-transition:enter="transition ease-out duration-100"
            x-transition:enter-start="opacity-0 -translate-y-1"
            x-transition:enter-end="opacity-100 translate-y-0"
            x-transition:leave="transition ease-in duration-75"
            x-transition:leave-start="opacity-100 translate-y-0"
            x-transition:leave-end="opacity-0 -translate-y-1"
            class="absolute z-50 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"
        >
            {# Loading state #}
            <div x-show="loading" class="px-3 py-2 text-sm text-gray-500">
                Buscando...
            </div>

            {# Options list #}
            <template x-for="(option, index) in filteredOptions" :key="option.value">
                <button
                    type="button"
                    @click="select(option.value, option.label)"
                    :class="{
                        'bg-primary-50 text-primary-700': option.value === selectedValue,
                        'bg-gray-100': highlightIndex === index && option.value !== selectedValue,
                        'text-gray-900': option.value !== selectedValue
                    }"
                    class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50 cursor-pointer"
                    x-text="option.label"
                ></button>
            </template>

            {# No results #}
            <div x-show="!loading && filteredOptions.length === 0" class="px-3 py-2 text-sm text-gray-500">
                No se encontraron resultados.
            </div>
        </div>
    </div>

    {% if help_text %}
    <p class="mt-1 text-sm text-gray-500">{{ help_text }}</p>
    {% endif %}
    {% if errors %}
    {% for error in errors %}
    <p class="mt-1 text-sm text-red-600">{{ error }}</p>
    {% endfor %}
    {% endif %}
</div>
